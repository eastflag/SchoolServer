<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aura.smartschool.persistence.MobileMapper">

<select id="selectHome" parameterType="Home" resultType="Integer">
	SELECT count(*) FROM HOME
	WHERE home_id = #{home_id}
</select> 

<select id="selectMember" parameterType="Member" resultType="Member">
	SELECT * FROM MEMBER
	WHERE  1=1
		<if test="mdn != null">and mdn=#{mdn}</if>
		<if test="member_id != null">and member_id=#{member_id}</if>
</select>

<select id="signIn" parameterType="Member" resultType="Member">
	SELECT * FROM member
	WHERE mdn=#{mdn} and home_id=#{home_id};
</select>

<select id="selectMemberList" parameterType="Home" resultType="Member">
	SELECT 
		M.member_id, M.home_id, M.mdn, M.gcm_id, M.is_parent, M.name, M.relation, M.photo, M.school_grade, M.school_class,
		S.school_id, S.School_name, 
		CAST(AES_DECRYPT(unhex(S.address), 'aura') AS CHAR(500)) as 'address', 
		CAST(AES_DECRYPT(unhex(S.new_address), 'aura') AS CHAR(500)) as 'new_address', 
		CAST(AES_DECRYPT(unhex(S.lat), 'aura') AS CHAR(20)) as 'lat', 
		CAST(AES_DECRYPT(unhex(S.lng), 'aura') AS CHAR(20)) as 'lng',
		S.homepage,
		S.contact
	FROM member M left join school S on M.school_id = S.school_id
	WHERE M.home_id = #{home_id}
</select>
	
<insert id="insertHome" parameterType="Home">
	INSERT INTO home(home_id) values(#{home_id});
</insert>

<insert id="insertMember" parameterType="Member">
	INSERT INTO 
		MEMBER(home_id, mdn, gcm_id, is_parent, name, relation, photo, school_id, school_grade, school_class, sex, birth_date) 
		values(#{home_id}, #{mdn}, #{gcm_id}, #{is_parent}, #{name}, #{relation}, #{photo}, 
		<choose>                                                                                                  
			<when test="school_id == 0">                                                                     
				null,                                                                                  
			</when>                                                                                               
			<otherwise>                                                                     
				#{school_id},                                                                                
			</otherwise>                                                                                               
		</choose> 
		#{school_grade}, #{school_class}, #{sex}, #{birth_date});
</insert>

<update id="updateMember" parameterType="Member">
	UPDATE MEMBER
	<set>
		<if test="mdn != null">mdn=#{mdn},</if>
		<if test="name != null">name=#{name},</if>
		<if test="relation != null">relation=#{relation},</if>
		<if test="photo != null">photo=#{photo},</if>
		<if test="school_id != null">school_id=#{school_id},</if>
		<if test="school_name != null">school_name=#{school_name},</if>
		<if test="school_grade != null">school_grade=#{school_grade},</if>
		<if test="school_class != null">school_class=#{school_class},</if>
		<if test="sex != null">sex=#{sex},</if>
		<if test="birth_date != null">birth_date=#{birth_date}</if>
	</set>
	WHERE member_id = #{member_id} 
</update>

<update id="updateGcmId" parameterType="Member">
	UPDATE MEMBER
		set gcm_id = #{gcm_id}
	WHERE home_id = #{home_id} and mdn = #{mdn}
</update>

<insert id="insertLocation" parameterType="LocationVO">
	INSERT INTO 
		LOCATION(member_id, lat, lng, address) 
		values(#{member_id}, 
			HEX(AES_ENCRYPT(#{lat}, 'aura')),
			HEX(AES_ENCRYPT(#{lng}, 'aura')), 
			HEX(AES_ENCRYPT(#{address}, 'aura'))
		);
</insert>

<select id="selectLastLocation" parameterType="Member" resultType="LocationVO">
	SELECT 
		member_id,
		CAST(AES_DECRYPT(unhex(address), 'aura') AS CHAR(500)) as 'address', 
		CAST(AES_DECRYPT(unhex(lat), 'aura') AS CHAR(20)) as 'lat', 
		CAST(AES_DECRYPT(unhex(lng), 'aura') AS CHAR(20)) as 'lng',
		CREATED_DATE
	FROM LOCATION
	WHERE member_id = #{member_id} and created_date >= curdate()
	ORDER BY CREATED_DATE desc
	LIMIT 1;
</select>

<select id="selectLastHomeLocation" parameterType="Home" resultType="LocationVO">
	SELECT location_id, member_id, lat, lng, created_date 
	from lat
	(select * from location
	where member_id in (select member_id from home where home_id = '길동이네집')
	order by created_date desc ) A
group by member_id;
</select>

<select id="selectLocationList" parameterType="Member" resultType="LocationVO">
	SELECT 
		CAST(AES_DECRYPT(unhex(address), 'aura') AS CHAR(500)) as 'address', 
		CAST(AES_DECRYPT(unhex(lat), 'aura') AS CHAR(20)) as 'lat', 
		CAST(AES_DECRYPT(unhex(lng), 'aura') AS CHAR(20)) as 'lng',
		CREATED_DATE
	FROM LOCATION
	WHERE member_id = #{member_id} and
		 created_date > date_format(curdate( ), '%Y-%m-%d %H:%i:%s' ) 
	ORDER BY CREATED_DATE asc
</select>

<select id="selectSchoolById" parameterType="Integer" resultType="SchoolVO">
	SELECT *
	FROM school
	WHERE school_id = #{school_id}
</select>

<select id="selectSchoolList" parameterType="SchoolVO" resultType="SchoolVO">
	SELECT *
	FROM school
	WHERE school_name like CONCAT(#{school_name},'%')
	order by school_name asc
</select>

<insert id="insertSchool" parameterType="SchoolVO">
	INSERT INTO school(
			school_name,
			gubun1,
			gubun2,
			zipcode,
			address,
			new_address,
			lat,
			lng,
			homepage,
			fax,
			contact,
			sido,
			gugun,
			support) 
		VALUES (
			#{name},
			#{gubun1},
			#{gubun2},
			#{zipcode},
			#{address},
			#{new_address},
			#{lat},
			#{lng},
			#{homepage},
			#{fax},
			#{contact},
			#{sido},
			#{gugun},
			#{support})
</insert>

<select id="selectBodySummary" parameterType="Member" resultType="BodyMeasureSummary">
	select member_id, measure_date, height, weight, bmi, muscle, fat, waist, growthGrade, ppm, cohd from 
		(select 
			measure_info.member_id,
			measure_info.measure_date,
			measure_info.smoke_seq,
			truncate(inbody_info.HEIGHT, 1) AS height,
			truncate(inbody_info.Weight, 1) AS weight,
			truncate(inbody_info.BMI, 2) AS bmi,
			inbody_info.Percent_Body_Fat AS fat,
			truncate(inbody_info.Soft_Lean_Mass, 1) AS muscle,
			truncate(inbody_info.Waist_Hip_Ratio, 3) AS waist,
			truncate(inbody_info.Fitness_Score, 0) AS growthGrade
		FROM 
			measure_info, inbody_info
		where
			measure_info.member_id = #{member_id} and
			measure_info.inbody_seq = inbody_info.inbody_seq) inbody 
		LEFT OUTER JOIN smoke_info 
		ON inbody.smoke_seq = smoke_info.smoke_seq
	ORDER BY measure_date desc;
</select>

<select id="selectGradeBySection" parameterType="BodyMeasureGrade" resultType="BodyMeasureGrade">
select 
	ms_grade_data.Ms_Grade_ID as gradeId,
	ms_grade_data.Srandard_Grade as gradeDesc,
	ms_grade_data.Section as section,
	#{value} as value,
	ms_grade_data.Grade_ID as schoolGradeId,
	ms_grade_data.sex as sex,
	standard_data.Year as year
from
	healthcare_gwangmyeong.ms_grade_data,
	healthcare_gwangmyeong.standard_data
where
	healthcare_gwangmyeong.ms_grade_data.Grade_ID = #{schoolGradeId}
		and healthcare_gwangmyeong.ms_grade_data.sex = #{sex}
		and healthcare_gwangmyeong.ms_grade_data.Section = #{section}
		and healthcare_gwangmyeong.standard_data.Year = #{year}
		and healthcare_gwangmyeong.standard_data.Ms_Grade_ID = ms_grade_data.Ms_Grade_ID
		and healthcare_gwangmyeong.standard_data.Start_Int &lt;= #{value}
		and healthcare_gwangmyeong.standard_data.End_Int &gt; #{value};
</select>

<select id="selectSmokerGrade" parameterType="string" resultType="BodyMeasureGrade">
select 
	smoke_data.Smoke_Data_ID as gradeId,
	smoke_data.DISCRIPTION as gradeDesc
from
	healthcare_gwangmyeong.smoke_data
where
	1 = 1
	and (#{ppm} between smoke_data.Start_Int and smoke_data.End_Int);
</select>

</mapper>